name: Build, Scan, Deploy to GKE

on:
  push:
    branches:
      - anushka

env:
  PROJECT_ID: chrome-reserve-476216-r9
  REGION: asia-south1
  REPO: frontend
  BACKEND_IMAGE_NAME: backend
  FRONTEND_IMAGE_NAME: frontend
  CLUSTER: gtm-staging
  ZONE: asia-south1-a
  TAG: ${{ github.sha }}

jobs:
  build-scan-deploy:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------------
      # CHECKOUT MAIN REPO
      # ------------------------------------------------------------------
      - name: Checkout main repo
        uses: actions/checkout@v4

      # ------------------------------------------------------------------
      # If backend exists in subfolder (backend/)
      # ------------------------------------------------------------------
      - name: Checkout backend (if separate repo)
        uses: actions/checkout@v4
        if: false # change to true if backend repo is separate
        with:
          repository: https://github.com/gotomarketlabs/backend.git
          path: backend

      # ------------------------------------------------------------------
      # SETUP GOOGLE CLOUD
      # ------------------------------------------------------------------
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.PROJECT_ID }}
          export_default_credentials: true

      - name: Authenticate Docker for Artifact Registry
        run: gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet

      # ------------------------------------------------------------------
      # BUILD BACKEND IMAGE
      # ------------------------------------------------------------------
      - name: Build Backend image
        working-directory: ./backend
        id: backendbuild
        run: |
          BACKEND_URI="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${BACKEND_IMAGE_NAME}:${TAG}"
          docker build -t "${BACKEND_URI}" .
          echo "backend_image=${BACKEND_URI}" >> $GITHUB_OUTPUT

      - name: Push Backend image
        run: |
          docker push "${{ steps.backendbuild.outputs.backend_image }}"

      # ------------------------------------------------------------------
      # BUILD FRONTEND IMAGE
      # ------------------------------------------------------------------
      - name: Build Frontend image
        working-directory: ./frontend
        id: frontendbuild
        run: |
          FRONTEND_URI="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${FRONTEND_IMAGE_NAME}:${TAG}"
          docker build -t "${FRONTEND_URI}" .
          echo "frontend_image=${FRONTEND_URI}" >> $GITHUB_OUTPUT

      - name: Push Frontend image
        run: |
          docker push "${{ steps.frontendbuild.outputs.frontend_image }}"

      # ------------------------------------------------------------------
      # PATCH MANIFESTS WITH NEW IMAGE TAGS
      # ------------------------------------------------------------------
      - name: Update manifest images
        run: |
          sed -i "s|{{BACKEND_IMAGE}}|${{ steps.backendbuild.outputs.backend_image }}|g" k8s/backend-deployment.yaml
          sed -i "s|{{FRONTEND_IMAGE}}|${{ steps.frontendbuild.outputs.frontend_image }}|g" k8s/frontend-deployment.yaml

      # ------------------------------------------------------------------
      # CONNECT TO GKE CLUSTER
      # ------------------------------------------------------------------
      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${CLUSTER} \
            --zone ${ZONE} \
            --project ${PROJECT_ID}

      # ------------------------------------------------------------------
      # DEPLOY
      # ------------------------------------------------------------------
      - name: Deploy to GKE
        run: |
          kubectl apply -f k8s/
          kubectl rollout status deployment/backend --timeout=180s
          kubectl rollout status deployment/frontend --timeout=180s
