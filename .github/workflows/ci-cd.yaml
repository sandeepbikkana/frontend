name: Frontend + Backend CI/CD to GKE

on:
  push:
    branches: ["mai"]

jobs:
  build-test-push-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Frontend
      uses: actions/checkout@v3

    - name: Checkout Backend Repo
      uses: actions/checkout@v3
      with:
        repository: sandeepbikkana/backend-service
        path: backend

    # Authenticate to Google Cloud
    - name: Auth to GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    # Install real gcloud + GKE auth plugin (required!)
    - name: Install gcloud + GKE auth plugin
      run: |
        echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
        sudo apt-get update
        sudo apt-get install -y google-cloud-cli google-cloud-sdk-gke-gcloud-auth-plugin kubectl
    - name: Configure Docker auth for Artifact Registry
      run: gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev

    # Build Frontend
    - name: Build Frontend Docker Image
      run: |
        cd frontend
        FE_IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/${{ secrets.AR_REPO_FRONTEND }}/frontend:${{ github.sha }}"
        echo "FE_IMAGE=$FE_IMAGE" >> $GITHUB_ENV
        docker build -t $FE_IMAGE .
    # Build Backend
    - name: Build Backend Docker Image
      run: |
        cd backend
        BE_IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/${{ secrets.AR_REPO_BACKEND }}/backend:${{ github.sha }}"
        echo "BE_IMAGE=$BE_IMAGE" >> $GITHUB_ENV
        docker build -t $BE_IMAGE .
    # Push images
    - name: Push Frontend Image
      run: docker push ${{ env.FE_IMAGE }}

    - name: Push Backend Image
      run: docker push ${{ env.BE_IMAGE }}

    # Get kubeconfig with the correct GKE plugin
    - name: Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER }} \
          --region=${{ secrets.GKE_LOCATION }}
    # Deploy backend
    - name: Deploy Backend to GKE
      run: |
        sed -i "s|IMAGE_BACKEND|${{ env.BE_IMAGE }}|g" k8s/backend-deployment.yaml
        kubectl apply -f k8s/backend-deployment.yaml
    # Deploy frontend
    - name: Deploy Frontend to GKE
      run: |
        sed -i "s|IMAGE_FRONTEND|${{ env.FE_IMAGE }}|g" k8s/frontend-deployment.yaml
        kubectl apply -f k8s/frontend-deployment.yaml
    # Apply other manifests (services, ingress, configmaps)
    - name: Apply All K8s Files
      run: kubectl apply -f k8s/

    # Verify rollouts
    - name: Verify Deployments
      run: |
        kubectl rollout status deployment/frontend-deployment --timeout=120s
        kubectl rollout status deployment/backend-deployment --timeout=120s






